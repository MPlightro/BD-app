<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Birthday Message Journal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="icon-192.png" />
<style>
  :root { --brand:#4f46e5; --bg:#f9fafb; --card:#fff; --text:#111827; --muted:#6b7280; }
  * { box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0; height: 100vh; display: flex; flex-direction: column;
    -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
  }
  header {
    position: sticky; top: 0; z-index: 20;
    background: var(--brand); color: #fff; padding: 14px 16px;
    display: flex; align-items: center; gap: 10px;
  }
  header h1 { font-size: 1.1rem; margin: 0; font-weight: 700; flex: 1; text-align: center; }
  #settings {
    position: sticky; top: 54px; z-index: 15;
    background: #eef2ff; color: #111827; padding: 8px 12px; display: flex; gap: 8px; align-items: center;
    border-bottom: 1px solid #c7d2fe;
  }
  #settings input {
    flex: 1; padding: 10px 12px; border: 1px solid #c7d2fe; border-radius: 8px; font-size: 15px; background: #fff;
  }
  #settings button {
    background: var(--brand); color:#fff; border:0; border-radius: 8px; padding: 10px 12px; font-size: 14px;
  }
  #container { flex: 1; overflow-y: auto; padding: 14px; -webkit-overflow-scrolling: touch; }
  .date-entry {
    background: var(--card); border-radius: 12px; padding: 12px; margin-bottom: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    border: 1px solid #e5e7eb;
  }
  .date-label { font-weight: 700; margin-bottom: 6px; font-size: 16px; color: #374151; }
  .meta { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
  textarea {
    width: 100%; min-height: 90px; font-size: 15px; padding: 10px 12px;
    border: 1px solid #d1d5db; border-radius: 10px; resize: vertical; background: #fdfdfd;
  }
  textarea:focus { outline: none; border-color: var(--brand); box-shadow: 0 0 4px rgba(79,70,229,0.35); }
  .highlight-today { border: 2px solid var(--brand); box-shadow: 0 0 10px rgba(79,70,229,0.18); }
  #actions {
    position: sticky; bottom: 0; z-index: 20; background: #fff; border-top: 1px solid #e5e7eb;
    padding: 10px; display: flex; gap: 10px; justify-content: center;
  }
  button.action {
    background: var(--brand); color: #fff; border: 0; border-radius: 10px; padding: 12px 14px; font-size: 15px; flex: 1; max-width: 180px;
  }
  .muted { color: var(--muted); }
</style>
</head>
<body>

<header>
  <h1>ðŸŽ‚ Birthday Message Journal</h1>
</header>

<div id="settings">
  <input id="userIdInput" placeholder="User ID (sync across devices)" />
  <button id="saveUserBtn">Use ID</button>
  <span class="muted" id="statusText"></span>
</div>

<div id="container"></div>

<div id="actions">
  <button class="action" id="copyBtn">ðŸ“‹ Copy All</button>
  <button class="action" id="clearBtn">ðŸ—‘ Clear (local)</button>
</div>

<script type="module">
  // --- PWA service worker ---
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }

  // --- Date range (2025-08-14 â†’ 2026-02-23) ---
  const startDate = new Date('2025-08-14');
  const endDate   = new Date('2026-02-23');

  // --- Utilities ---
  const container   = document.getElementById('container');
  const userIdInput = document.getElementById('userIdInput');
  const saveUserBtn = document.getElementById('saveUserBtn');
  const statusText  = document.getElementById('statusText');
  const copyBtn     = document.getElementById('copyBtn');
  const clearBtn    = document.getElementById('clearBtn');

  const fmtLabel = (d) => d.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
  const fmtKey   = (d) => d.toISOString().slice(0,10); // YYYY-MM-DD (UTC; fine for consistent keys)

  // Local cache (so it survives full offline reloads)
  const LOCAL_KEY_PREFIX = 'birthdayMessages_v2_';
  const localGetAll = (uid) => JSON.parse(localStorage.getItem(LOCAL_KEY_PREFIX + uid) || '{}');
  const localSaveAll = (uid, obj) => localStorage.setItem(LOCAL_KEY_PREFIX + uid, JSON.stringify(obj));

  // --- User ID handling ---
  function ensureUserId() {
    let uid = localStorage.getItem('journalUserId');
    if (!uid) {
      // Simple random default; can be replaced with your own string for shared sync
      uid = 'user_' + Math.random().toString(36).slice(2,10);
      localStorage.setItem('journalUserId', uid);
    }
    userIdInput.value = uid;
    return uid;
  }
  function setUserId(uid) {
    localStorage.setItem('journalUserId', uid);
    userIdInput.value = uid;
    location.reload(); // re-init listeners for new user
  }
  const userId = ensureUserId();

  // --- Firebase (Realtime Database) ---
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
  import { getDatabase, ref, onValue, update } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js';

  // FILL THESE FROM FIREBASE CONSOLE (Project Settings â†’ General)
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    databaseURL: "https://lh2d-a08bd-default-rtdb.firebaseio.com",
    projectId: "lh2d-a08bd",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // Status helper
  function setStatus(msg) { statusText.textContent = msg; }

  // Debounce helper
  const debouncers = new Map();
  function debounce(key, fn, delay=400) {
    clearTimeout(debouncers.get(key));
    debouncers.set(key, setTimeout(fn, delay));
  }

  // Build UI and wire realtime listeners
  const localCache = localGetAll(userId);
  let todayEl = null;
  const todayLabel = fmtLabel(new Date());

  // Keep refs to textareas by key
  const textareas = new Map();

  function buildEntries() {
    let d = new Date(startDate);
    while (d <= endDate) {
      const label = fmtLabel(d);
      const key   = fmtKey(d);

      const card = document.createElement('div');
      card.className = 'date-entry';
      if (label === todayLabel) card.classList.add('highlight-today');

      const title = document.createElement('div');
      title.className = 'date-label';
      title.textContent = label;

      const meta  = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = 'Savingâ€¦';

      const ta = document.createElement('textarea');
      ta.value = localCache[key]?.text || '';
      textareas.set(key, ta);

      ta.addEventListener('input', () => {
        const now = Date.now();
        // Update local cache immediately (so offline reloads show new text)
        localCache[key] = { text: ta.value, updatedAt: now };
        localSaveAll(userId, localCache);

        // Push to Firebase (debounced)
        debounce('save-'+key, async () => {
          const path = `users/${userId}/messages/${key}`;
          await update(ref(db, path), { text: ta.value, updatedAt: now });
          meta.textContent = 'Saved âœ“';
          setTimeout(() => (meta.textContent = ''), 1200);
        });
      });

      card.appendChild(title);
      card.appendChild(meta);
      card.appendChild(ta);
      container.appendChild(card);

      if (label === todayLabel) {
        todayEl = card;
      }

      // Realtime listener: merge remote â†’ UI/local if it's newer
      const path = `users/${userId}/messages/${key}`;
      onValue(ref(db, path), (snap) => {
        const remote = snap.val(); // { text, updatedAt }
        if (!remote) return;
        const local = localCache[key] || { text:'', updatedAt:0 };
        if ((remote.updatedAt || 0) > (local.updatedAt || 0)) {
          localCache[key] = remote;
          localSaveAll(userId, localCache);
          // Avoid cursor jump if user is currently typing the same content
          if (ta.value !== remote.text) ta.value = remote.text || '';
        }
      });
      d.setDate(d.getDate() + 1);
    }

    // Auto-scroll & focus to today
    if (todayEl) {
      setTimeout(() => {
        todayEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        const ta = todayEl.querySelector('textarea');
        if (ta) ta.focus();
      }, 250);
    }
  }

  buildEntries();
  setStatus(`Syncing as ${userId}`);

  // Settings actions
  saveUserBtn.addEventListener('click', () => {
    const newId = userIdInput.value.trim();
    if (!newId) return;
    setUserId(newId);
  });

  // Copy all
  copyBtn.addEventListener('click', () => {
    let output = '';
    let d = new Date(startDate);
    while (d <= endDate) {
      const label = fmtLabel(d);
      const key   = fmtKey(d);
      const val   = textareas.get(key)?.value?.trim();
      if (val) output += `${label}: ${val}\n\n`;
      d.setDate(d.getDate() + 1);
    }
    navigator.clipboard.writeText(output.trim());
    alert('Copied!');
  });

  // Clear LOCAL ONLY (keeps Firebase)
  clearBtn.addEventListener('click', () => {
    if (!confirm('Clear local cache only? (Cloud data remains)')) return;
    localStorage.removeItem(LOCAL_KEY_PREFIX + userId);
    location.reload();
  });
</script>
</body>
</html>
